#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>

#include <string>

const unsigned char desmume_footer[] = {
    0x7c, 0x3c, 0x2d, 0x2d, 0x53, 0x6e, 0x69, 0x70, 0x20, 0x61, 0x62, 0x6f, 0x76, 0x65, 0x20, 0x68,
    0x65, 0x72, 0x65, 0x20, 0x74, 0x6f, 0x20, 0x63, 0x72, 0x65, 0x61, 0x74, 0x65, 0x20, 0x61, 0x20,
    0x72, 0x61, 0x77, 0x20, 0x73, 0x61, 0x76, 0x20, 0x62, 0x79, 0x20, 0x65, 0x78, 0x63, 0x6c, 0x75,
    0x64, 0x69, 0x6e, 0x67, 0x20, 0x74, 0x68, 0x69, 0x73, 0x20, 0x44, 0x65, 0x53, 0x6d, 0x75, 0x4d,
    0x45, 0x20, 0x73, 0x61, 0x76, 0x65, 0x64, 0x61, 0x74, 0x61, 0x20, 0x66, 0x6f, 0x6f, 0x74, 0x65,
    0x72, 0x3a, 0x45, 0x91, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x03, 0x00, 0x00, 0x00, 0x02, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x2d, 0x44, 0x45, 0x53, 0x4d,
    0x55, 0x4d, 0x45, 0x20, 0x53, 0x41, 0x56, 0x45, 0x2d, 0x7c
};


int main (int argc, char **argv) {

    if (argc<2) {
        fprintf(stderr, "Usage: %s infile [outfile]\n",argv[0]);
        exit(1);
    }

    std::string infile, outfile, ext, outext;
    size_t lastdot;

    infile = argv[1];

    if ( (lastdot = infile.rfind("."))!= std::string::npos ) {
        ext = infile.substr(lastdot);
    }

    if (argc >= 3) {
        outfile =argv[2];
    } else {
        outfile = infile.substr(0,lastdot);
        outfile += ".dsv";
    }

    FILE *in = fopen(infile.c_str(), "rb");

    if (in == NULL) {
        printf("Error: cannot open %s for reading\n", infile.c_str());
        exit(1);
    }

    fseek(in, 0, SEEK_END);

    size_t fileSize = ftell(in);

    fseek(in, 0, SEEK_SET);

    uint8_t *buffer = (uint8_t*)malloc(fileSize);

    fread(buffer, 1, fileSize, in);

    fclose(in);

    FILE *out = fopen(outfile.c_str(), "wb");

    if (out == NULL) {
        printf("Error: cannot open %s for writing\n", outfile.c_str());
        exit(1);
    }

    fwrite(buffer, 1, fileSize, out);
    fwrite(desmume_footer, 1, sizeof(desmume_footer), out);

    fclose(out);

    return 0;
}